#!/usr/bin/env bash
set -euo pipefail

usage() {
  echo "Usage:"
  echo "  swapws WORKSPACE"
  echo "  swapws --move WORKSPACE"
  exit 1
}

MOVE_CONTAINER=false
if [ $# -eq 0 ]; then usage; fi
if [ "${1:-}" = "--move" ]; then
  MOVE_CONTAINER=true
  shift
fi
[ $# -eq 1 ] || usage

TARGET_WS="$1"

# Snapshot workspace state
WORKSPACES="$(swaymsg -t get_workspaces -r)"

FOCUSED_WS="$(jq -r '.[] | select(.focused==true) | .name' <<<"$WORKSPACES")"
FOCUSED_OUTPUT="$(jq -r '.[] | select(.focused==true) | .output' <<<"$WORKSPACES")"

TARGET_OUTPUT="$(jq -r --arg ws "$TARGET_WS" '.[] | select(.name==$ws) | .output' <<<"$WORKSPACES" | head -n1 || true)"

# Optional: move focused container to the target workspace (Hyprland-like Shift behavior)
# This may change focus/output, so we restore focus to the original output afterward.
if $MOVE_CONTAINER; then
  swaymsg "move container to workspace \"${TARGET_WS}\"" >/dev/null
  swaymsg "focus output \"${FOCUSED_OUTPUT}\"" >/dev/null
fi

# If target workspace doesn't exist yet, just focus it (it will appear on the focused output)
if [ -z "${TARGET_OUTPUT}" ]; then
  swaymsg "workspace \"${TARGET_WS}\"" >/dev/null
  exit 0
fi

# Already on focused output? Just focus it.
if [ "${TARGET_OUTPUT}" = "${FOCUSED_OUTPUT}" ]; then
  swaymsg "workspace \"${TARGET_WS}\"" >/dev/null
  exit 0
fi

# Determine whether the currently focused workspace is "empty" (no tiling or floating containers).
# We use get_tree to avoid guessing.
FOCUSED_WS_CONTAINER_COUNT="$(
  swaymsg -t get_tree -r | jq -r --arg ws "$FOCUSED_WS" '
    [.. | objects | select(.type?=="workspace" and .name?==$ws)
      | ((.nodes|length) + (.floating_nodes|length))
    ] | first // 0
  '
)"

# 1) Bring target workspace onto the focused output
swaymsg "[workspace=\"${TARGET_WS}\"] move workspace to output \"${FOCUSED_OUTPUT}\"" >/dev/null

# 2) Put the focused workspace onto the target output:
#    - If it has containers: move it normally (true swap)
#    - If it's empty: just switch the target output to that workspace name (creates/assigns the empty ws there)
if [ "${FOCUSED_WS_CONTAINER_COUNT}" -gt 0 ]; then
  swaymsg "[workspace=\"${FOCUSED_WS}\"] move workspace to output \"${TARGET_OUTPUT}\"" >/dev/null
else
  swaymsg "focus output \"${TARGET_OUTPUT}\"" >/dev/null
  swaymsg "workspace \"${FOCUSED_WS}\"" >/dev/null
  swaymsg "focus output \"${FOCUSED_OUTPUT}\"" >/dev/null
fi

# 3) Focus the target workspace (now on the focused output)
swaymsg "workspace \"${TARGET_WS}\"" >/dev/null
