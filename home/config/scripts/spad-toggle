#!/usr/bin/env bash
set -euo pipefail

# spad-toggle: togglable scratchpad popup behavior (dwm/pyprland-like) for Sway.
#
# Usage:
#   spad-toggle <app_id> '<exec command>' [width_ppt] [height_ppt]
#
# Example:
#   spad-toggle impala 'foot -T impala -a impala impala' 70 70

APP_ID="${1:?missing app_id}"
CMD="${2:?missing command}"
WIDTH="${3:-70}"
HEIGHT="${4:-70}"

TREE="$(swaymsg -t get_tree)"
FOCUSED_WS="$(jq -r '.. | objects | select(.type?=="workspace" and .focused==true) | .name' <<<"$TREE" | head -n1)"

find_id() {
  swaymsg -t get_tree | jq -r --arg app "$APP_ID" '
    .. | objects | select(.app_id? == $app) | .id
  ' | head -n1
}

find_workspace_of_id() {
  local id="$1"
  swaymsg -t get_tree | jq -r --argjson id "$id" '
    .. | objects
    | select(.type?=="workspace")
    | select((.nodes + .floating_nodes) | .. | objects | select(.id?==$id) | length > 0)
    | .name
  ' | head -n1
}

apply_popup_geometry() {
  # Keep it floating, centered, and consistently sized.
  swaymsg \
    "[app_id=\"$APP_ID\"] floating enable" \
    "[app_id=\"$APP_ID\"] resize set width ${WIDTH} ppt height ${HEIGHT} ppt" \
    "[app_id=\"$APP_ID\"] move position center"
}

spawn_then_show() {
  swaymsg "exec $CMD"

  # Wait until the window appears (fast poll; avoids race conditions).
  local id=""
  for _ in $(seq 1 50); do
    id="$(find_id || true)"
    [[ -n "$id" ]] && break
    sleep 0.05
  done

  # If it still didn't appear, just exit quietly.
  [[ -z "$id" ]] && exit 0

  # Make it popup-like and ensure it is managed as a scratchpad toggle.
  apply_popup_geometry
  swaymsg "[con_id=$id] move scratchpad" >/dev/null
  swaymsg "[con_id=$id] scratchpad show" >/dev/null
}

main() {
  local id
  id="$(find_id || true)"

  # 1) Not running → spawn + show as popup
  if [[ -z "${id:-}" ]]; then
    spawn_then_show
    exit 0
  fi

  # 2) Determine where it currently lives
  local ws
  ws="$(find_workspace_of_id "$id" || true)"

  # If it is currently on the focused workspace → HIDE (move to scratchpad)
  if [[ -n "${ws:-}" && "${ws}" == "${FOCUSED_WS}" ]]; then
    swaymsg "[con_id=$id] move scratchpad" >/dev/null
    exit 0
  fi

  # Otherwise → SHOW on current workspace (even if it lives elsewhere)
  # Move to scratchpad first, then show (this “teleports” it here).
  swaymsg "[con_id=$id] move scratchpad" >/dev/null || true
  swaymsg "[con_id=$id] scratchpad show" >/dev/null

  # Re-apply popup geometry in case it got resized/moved earlier.
  apply_popup_geometry
}

main "$@"
