#!/usr/bin/env bash
set -euo pipefail

usage() {
  echo "Usage:"
  echo "  swapws WORKSPACE"
  echo "  swapws --move WORKSPACE"
  exit 1
}

MOVE_CONTAINER=false

if [ $# -eq 0 ]; then
  usage
fi

if [ "$1" = "--move" ]; then
  MOVE_CONTAINER=true
  shift
fi

[ $# -eq 1 ] || usage

TARGET_WS="$1"

WORKSPACES="$(swaymsg -t get_workspaces -r)"

# Focused output
FOCUSED_OUTPUT="$(
  jq -r '.[] | select(.focused==true) | .output' <<<"$WORKSPACES"
)"

# Workspace currently shown on focused output (even if empty)
FOCUSED_OUTPUT_WS="$(
  jq -r --arg out "$FOCUSED_OUTPUT" '
    .[] | select(.output==$out) | .name
  ' <<<"$WORKSPACES" | head -n1
)"

# Output where target workspace currently lives (if it exists)
TARGET_OUTPUT="$(
  jq -r --arg ws "$TARGET_WS" '
    .[] | select(.name==$ws) | .output
  ' <<<"$WORKSPACES" | head -n1 || true
)"

# Optional: move focused container first
if $MOVE_CONTAINER; then
  swaymsg "move container to workspace \"${TARGET_WS}\"" >/dev/null
fi

# Target workspace does not exist yet → just open it here
if [ -z "${TARGET_OUTPUT}" ]; then
  swaymsg "workspace \"${TARGET_WS}\"" >/dev/null
  exit 0
fi

# Target already on focused output → just focus it
if [ "${TARGET_OUTPUT}" = "${FOCUSED_OUTPUT}" ]; then
  swaymsg "workspace \"${TARGET_WS}\"" >/dev/null
  exit 0
fi

# Swap workspaces between outputs
swaymsg "[workspace=\"${FOCUSED_OUTPUT_WS}\"] move workspace to output \"${TARGET_OUTPUT}\"" >/dev/null
swaymsg "[workspace=\"${TARGET_WS}\"] move workspace to output \"${FOCUSED_OUTPUT}\"" >/dev/null

# Focus target on the current output
swaymsg "workspace \"${TARGET_WS}\"" >/dev/null
