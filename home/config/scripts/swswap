#!/usr/bin/env bash
set -euo pipefail

usage() {
  echo "Usage:"
  echo "  swapws WORKSPACE"
  echo "  swapws --move WORKSPACE"
  exit 1
}

MOVE_CONTAINER=false
if [ $# -eq 0 ]; then usage; fi
if [ "${1:-}" = "--move" ]; then
  MOVE_CONTAINER=true
  shift
fi
[ $# -eq 1 ] || usage

TARGET_WS="$1"

workspaces_json() { swaymsg -t get_workspaces -r; }

# Count containers in a workspace (tiling + floating)
ws_container_count() {
  local ws="$1"
  swaymsg -t get_tree -r | jq -r --arg ws "$ws" '
    [.. | objects
      | select(.type?=="workspace" and .name?==$ws)
      | ((.nodes|length) + (.floating_nodes|length))
    ] | first // 0
  '
}

WS_JSON="$(workspaces_json)"

ORIGIN_WS="$(jq -r '.[] | select(.focused==true) | .name'   <<<"$WS_JSON")"
ORIGIN_OUT="$(jq -r '.[] | select(.focused==true) | .output'<<<"$WS_JSON")"

TARGET_OUT="$(jq -r --arg ws "$TARGET_WS" '.[] | select(.name==$ws) | .output' <<<"$WS_JSON" | head -n1 || true)"

# If target workspace doesn't exist yet: just open it on the focused output
if [ -z "${TARGET_OUT}" ]; then
  swaymsg "workspace \"${TARGET_WS}\"" >/dev/null
  exit 0
fi

# If it's already on the focused output: just focus it
if [ "${TARGET_OUT}" = "${ORIGIN_OUT}" ]; then
  swaymsg "workspace \"${TARGET_WS}\"" >/dev/null
  exit 0
fi

# Optional: move focused container first, then return to origin output
if $MOVE_CONTAINER; then
  swaymsg "move container to workspace \"${TARGET_WS}\"" >/dev/null
  swaymsg "focus output \"${ORIGIN_OUT}\"" >/dev/null
fi

ORIGIN_COUNT="$(ws_container_count "${ORIGIN_WS}")"
TARGET_COUNT="$(ws_container_count "${TARGET_WS}")"

# Move only the non-empty side(s). Empty workspaces are handled by explicitly selecting them on outputs later.
if [ "${ORIGIN_COUNT}" -gt 0 ]; then
  swaymsg "[workspace=\"${ORIGIN_WS}\"] move workspace to output \"${TARGET_OUT}\"" >/dev/null
fi

if [ "${TARGET_COUNT}" -gt 0 ]; then
  swaymsg "[workspace=\"${TARGET_WS}\"] move workspace to output \"${ORIGIN_OUT}\"" >/dev/null
fi

# CRITICAL: force each output to show the intended workspace (prevents Sway from "choosing" workspace 3, etc.)
swaymsg "focus output \"${TARGET_OUT}\"" >/dev/null
swaymsg "workspace \"${ORIGIN_WS}\"" >/dev/null

swaymsg "focus output \"${ORIGIN_OUT}\"" >/dev/null
swaymsg "workspace \"${TARGET_WS}\"" >/dev/null
